<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.domain.financialproduct.depositsaving.mapper.DepositMapper">

    <resultMap id="DepositResultMap" type="org.scoula.domain.financialproduct.depositsaving.entity.Deposit">
        <id property="depositId" column="deposit_id"/>
        <result property="financialCompanyId" column="financial_company_id"/>
        <result property="name" column="name"/>
        <result property="saveMonth" column="save_month"/>
        <result property="interestRate" column="interest_rate"/>
        <result property="maxInterestRate" column="max_interest_rate"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="productCode" column="product_code"/>
        <result property="companyCode" column="company_code"/>
    </resultMap>

    <resultMap id="DepositSpclConditionResultMap"
               type="org.scoula.domain.financialproduct.depositsaving.entity.DepositSpclCondition">
        <id property="id" column="id"/>
        <result property="depositId" column="deposit_id"/>
        <result property="spclCondition" column="spcl_condition"
                javaType="org.scoula.domain.financialproduct.constants.DepositSpclConditionType"
                typeHandler="org.scoula.domain.financialproduct.handler.DepositSpclConditionTypeHandler"/>
        <result property="productCode" column="product_code"/>
        <result property="companyCode" column="company_code"/>
        <result property="saveMonth" column="save_month"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insertBatch">
        Insert Into deposit(
        financial_company_id, name, save_month, interest_rate, max_interest_rate,
        product_code, company_code, created_at, updated_at
        ) values
        <foreach collection="deposits" item="item" separator=",">
            (
            #{item.financialCompanyId}, #{item.name}, #{item.saveMonth}, #{item.interestRate},
            #{item.maxInterestRate}, #{item.productCode}, #{item.companyCode},
            NOW(), NOW()
            )
        </foreach>
    </insert>
    <insert id="insertSpclCondition">
        INSERT INTO deposit_spcl_condition(
        deposit_id, spcl_condition, product_code, company_code,
        save_month, created_at, updated_at
        ) VALUES
        <foreach collection="spclConditions" item="condition" separator=",">
            (
            #{condition.depositId},
            #{condition.spclCondition, javaType=org.scoula.domain.financialproduct.constants.DepositSpclConditionType, jdbcType=VARCHAR},
            #{condition.productCode},
            #{condition.companyCode},
            #{condition.saveMonth},
            NOW(), NOW()
            )
        </foreach>
    </insert>

    <select id="selectAllDeposits" resultMap="DepositResultMap">
        SELECT *
        FROM deposit
        ORDER BY max_interest_rate DESC, interest_rate DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    <select id="countAllDeposits" resultType="int">
        SELECT COUNT(*)
        FROM deposit
    </select>

    <select id="selectDepositsWithFilters" resultMap="DepositResultMap">
        SELECT DISTINCT d.deposit_id,
        d.financial_company_id,
        d.name,
        d.save_month,
        d.interest_rate,
        d.max_interest_rate,
        d.product_code,
        d.company_code,
        d.created_at,
        d.updated_at
        FROM deposit d
        LEFT JOIN deposit_spcl_condition dsc ON d.deposit_id = dsc.deposit_id
        WHERE 1=1
        <if test="spclConditions != null and spclConditions.size() > 0">
            AND dsc.spcl_condition IN
            <foreach collection="spclConditions" item="condition" open="(" close=")" separator=",">
                #{condition}
            </foreach>
        </if>

        <if test="remainTime != null">
            AND d.save_month &lt;= #{remainTime}
        </if>
        ORDER BY d.max_interest_rate DESC, d.interest_rate DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    <select id="countDepositsWithFilters" resultType="int">
        SELECT COUNT(DISTINCT d.deposit_id)
        FROM deposit d
        LEFT JOIN deposit_spcl_condition dsc ON d.deposit_id = dsc.deposit_id
        WHERE 1=1

        <if test="spclConditions != null and spclConditions.size() > 0">
            AND dsc.spcl_condition IN
            <foreach collection="spclConditions" item="condition" open="(" close=")" separator=",">
                #{condition}
            </foreach>
        </if>

        <if test="remainTime != null">
            AND d.save_month &lt;= #{remainTime}
        </if>
    </select>
    <select id="selectProductDetailById" resultMap="DepositResultMap">
        SELECT d.deposit_id,
               d.financial_company_id,
               d.name,
               d.save_month,
               d.interest_rate,
               d.max_interest_rate,
               d.product_code,
               d.company_code,
               d.created_at,
               d.updated_at
        FROM deposit d
        WHERE d.deposit_id = #{id}
    </select>
    <select id="selectSpclConditionsByDepositId" resultMap="DepositSpclConditionResultMap">
        SELECT id,
               deposit_id,
               spcl_condition,
               product_code,
               company_code,
               save_month,
               created_at,
               updated_at
        FROM deposit_spcl_condition
        WHERE deposit_id = #{depositId}
        ORDER BY spcl_condition
    </select>
    <select id="selectByProductAndCompanyCode" resultMap="DepositResultMap">
        SELECT deposit_id,
               financial_company_id,
               name,
               save_month,
               interest_rate,
               max_interest_rate,
               product_code,
               company_code,
               created_at,
               updated_at
        FROM deposit
        WHERE product_code = #{productCode}
          AND company_code = #{companyCode}
          AND save_month = #{saveMonth}
    </select>
</mapper>
