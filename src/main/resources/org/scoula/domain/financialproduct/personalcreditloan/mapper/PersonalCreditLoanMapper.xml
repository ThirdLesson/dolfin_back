<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.scoula.domain.financialproduct.personalcreditloan.mapper.PersonalCreditLoanMapper">


    <resultMap id="personalCreditLoanResultMap" type="org.scoula.domain.financialproduct.personalcreditloan.entity.PersonalCreditLoan">
        <!-- 기본 필드 매핑 -->
        <id property="personalLoanId" column="personal_loan_id"/>
        <result property="financialCompanyId" column="financial_company_id"/>
        <result property="productName" column="product_name"/>
        <result property="baseRate" column="base_rate"/>
        <result property="maxRate" column="max_rate"/>
        <result property="spreadRate" column="spread_rate"/>
        <result property="maxLoanAmount" column="max_loan_amount"/>
        <result property="minPeriodMonths" column="min_period_months"/>
        <result property="maxPeriodMonths" column="max_period_months"/>
        <result property="rateInfo" column="rate_info"/>
        <result property="loanConditions" column="loan_conditions"/>
        <result property="foreignerAvailable" column="foreigner_available"/>
        <result property="visaMinMonths" column="visa_min_months"/>
        <result property="isActive" column="is_active"/>

        <!-- JOIN 필드 매핑 -->
        <result property="companyName" column="company_name"/>
        <result property="companyCode" column="company_code"/>
        <result property="companyCallNumber" column="company_call_number"/>
        <result property="companyHomeUrl" column="company_home_url"/>
    </resultMap>

    <select id="findLoansByConditions" resultMap="personalCreditLoanResultMap">
        SELECT
        pcl.*,
        fc.name AS company_name,
        fc.code AS company_code,
        fc.callnumber AS company_call_number,
        fc.homp_url AS company_home_url
        FROM personal_credit_loan pcl
        JOIN financial_company fc ON pcl.financial_company_id = fc.financial_company_id
        WHERE pcl.is_active = true

        <!-- 대출 금액 필터 -->
        <if test="minAmount != null and maxAmount != null">
            AND pcl.max_loan_amount BETWEEN #{minAmount} AND #{maxAmount}
        </if>

        <!-- 금리 기준 정렬 -->
        <choose>
            <when test="filterType == 'MIN_RATE'">
                ORDER BY pcl.base_rate ASC
            </when>
            <when test="filterType == 'MAX_RATE'">
                ORDER BY pcl.max_rate ASC
            </when>
            <when test="filterType == 'AVG_RATE'">
                ORDER BY pcl.spread_rate ASC
            </when>
            <otherwise>
                ORDER BY pcl.base_rate ASC  <!-- 기본값 -->
            </otherwise>
        </choose>

        <!-- 페이징 -->
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 개수 조회 (페이징을 위해 필요) -->
    <select id="countLoansByConditions" resultType="int">
        SELECT COUNT(*)
        FROM personal_credit_loan pcl
        JOIN financial_company fc ON pcl.financial_company_id = fc.financial_company_id
        WHERE pcl.is_active = true

        <!-- 대출 금액 필터 -->
        <if test="minAmount != null and maxAmount != null">
            AND pcl.max_loan_amount BETWEEN #{minAmount} AND #{maxAmount}
        </if>
    </select>


    <select id="findById" resultMap="personalCreditLoanResultMap">
        SELECT
            pcl.*,
            fc.name AS company_name,
            fc.code AS company_code,
            fc.callnumber AS company_call_number,
            fc.homp_url AS company_home_url
        FROM personal_credit_loan pcl
                 JOIN financial_company fc ON pcl.financial_company_id = fc.financial_company_id
        WHERE pcl.personal_loan_id = #{id}
          AND pcl.is_active = true
    </select>


</mapper>
