<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.domain.exchange.mapper.ExchangeRateMapper">
    <resultMap id="exchangeRateMap" type="org.scoula.domain.exchange.entity.ExchangeRate">
        <id property="exchangeId" column="exchange_id"/>
        <result property="baseExchange" column="base_exchange"/>
        <result property="targetExchange" column="target_exchange"/>
        <result property="exchangeValue" column="exchange_value"/>
        <result property="bankName" column="bank_name"/>
        <result property="exchangeDate" column="exchange_date"/>
        <result property="type" column="type"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="findLatestExchangeRate" resultMap="exchangeRateMap">
        SELECT
            exchange_id,
            base_exchange,
            target_exchange,
            exchange_value,
            bank_name,
            exchange_date,
            type,
            created_at,
            updated_at
        FROM exchange_rate
        WHERE bank_name = #{bankName}
          AND type = #{type}
          AND base_exchange = 'KRW'
          AND target_exchange = #{targetCurrency}
          AND exchange_value > 0
        ORDER BY created_at DESC
            LIMIT 1
    </select>


    <select id="findByBankAndTargetCurrencyAndType" resultMap="exchangeRateMap">
        SELECT exchange_id, base_exchange, target_exchange, exchange_value,
               bank_name, type, exchange_date, created_at, updated_at
        FROM exchange_rate
        WHERE bank_name = #{bankName}
          AND target_exchange = #{targetCurrency}
          AND type = #{type}
          AND exchange_date = (
            SELECT MAX(exchange_date)
            FROM exchange_rate
            WHERE bank_name = #{bankName}
              AND target_exchange = #{targetCurrency}
              AND type = #{type}
        )
            LIMIT 1
    </select>


    <select id="findLatestRates" resultMap="exchangeRateMap">
        SELECT exchange_id, base_exchange, target_exchange, exchange_value,
               bank_name, type, exchange_date, created_at, updated_at
        FROM exchange_rate
        WHERE target_exchange = #{targetCurrency}
          AND type = #{type}
          AND exchange_date = (
            SELECT MAX(exchange_date)
            FROM exchange_rate
            WHERE type = BASE
        )
        ORDER BY exchange_value ASC
    </select>

    <select id="findUsdExchangeRate" resultMap="exchangeRateMap">
        SELECT exchange_id, base_exchange, target_exchange, exchange_value,
               bank_name, type, exchange_date, created_at, updated_at
        FROM exchange_rate
        WHERE target_exchange = 'USD'
          AND type = 'BASE'
          AND bank_name = #{bankName}
        ORDER BY exchange_date DESC, created_at DESC
            LIMIT 1
    </select>

    <select id="getExchangeLiveList" resultType="org.scoula.domain.exchange.dto.response.ExchangeLiveResponse">
        SELECT e1.target_exchange AS currency,
               e1.exchange_value AS exchangeRate
        FROM exchange_rate e1
                 INNER JOIN (
            SELECT target_exchange,
                   MAX(created_at) as max_created_at
            FROM exchange_rate
            WHERE base_exchange = 'KRW'
              AND bank_name = '국민은행'
              AND type = 'BASE'
              AND target_exchange IN ('USD', 'JPY', 'EUR', 'GBP', 'CAD', 'HKD',
                                      'CNY', 'THB', 'IDR', 'VND', 'RUB', 'MYR')
            GROUP BY target_exchange
        ) e2 ON e1.target_exchange = e2.target_exchange
            AND e1.created_at = e2.max_created_at
        WHERE e1.base_exchange = 'KRW'
          AND e1.bank_name = '국민은행'
          AND e1.type = 'BASE'
        ORDER BY CASE e1.target_exchange
                     WHEN 'USD' THEN 1
                     WHEN 'JPY' THEN 2
                     WHEN 'EUR' THEN 3
                     WHEN 'GBP' THEN 4
                     WHEN 'CAD' THEN 5
                     WHEN 'HKD' THEN 6
                     WHEN 'CNY' THEN 7
                     WHEN 'THB' THEN 8
                     WHEN 'IDR' THEN 9
                     WHEN 'VND' THEN 10
                     WHEN 'RUB' THEN 11
                     WHEN 'MYR' THEN 12
                     END
    </select>

</mapper>
